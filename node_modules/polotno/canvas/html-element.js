"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTMLElement=void 0;const react_1=__importDefault(require("react")),react_dom_1=__importDefault(require("react-dom")),mobx_react_lite_1=require("mobx-react-lite"),react_konva_1=require("react-konva"),use_snap_1=require("./use-snap"),html2canvas_1=require("../utils/html2canvas"),use_fadein_1=require("./use-fadein"),react_konva_utils_1=require("react-konva-utils");class Portal extends react_1.default.Component{componentDidMount(){this.renderPortal()}componentDidUpdate(e){this.renderPortal()}componentWillUnmount(){var e;react_dom_1.default.unmountComponentAtNode(this.defaultNode),null===(e=this.defaultNode)||void 0===e||e.parentNode.removeChild(this.defaultNode),this.defaultNode=null}renderPortal(e){this.defaultNode||(this.defaultNode=document.createElement("div"),this.props.node.appendChild(this.defaultNode)),react_dom_1.default.render(this.props.children,this.defaultNode)}render(){return null}}const TextInput=(0,mobx_react_lite_1.observer)((({textNodeRef:e,element:t,onBlur:a})=>{const[r,n]=react_1.default.useState({}),o=e.current;var l=o.absolutePosition(),i=o.getAbsoluteScale().x,d=l.x,s=l.y;react_1.default.useLayoutEffect((()=>{const e={position:"absolute"};e.top=s+"px",e.left=d+"px",e.width=o.width()-2*o.padding()+"px",e.height=o.height()-2*o.padding()+10+"px",e.fontSize=o.fontSize()+"px",e.border="none",e.padding="0px",e.margin="0px",e.overflow="hidden",e.background="none",e.outline="none",e.resize="none",e.lineHeight=o.lineHeight()+.01,e.fontFamily='"'+o.fontFamily()+'"',e.transformOrigin="left top",e.textAlign=o.align(),e.color=o.fill(),e.transform=`rotateZ(${o.rotation()}deg) scale(${i})`,e.overflowWrap="break-word",e.whiteSpace="pre-wrap",e.userSelect="text",e.wordBreak="normal",JSON.stringify(e)!==JSON.stringify(r)&&n(e)}));const c=react_1.default.useRef(null);return react_1.default.useEffect((()=>{var e;r.position&&(null===(e=c.current)||void 0===e||e.focus())}),[r.position]),react_1.default.useEffect((()=>{c.current&&c.current.innerText!==t.text&&(c.current.innerText=t.text)}),[t.text]),react_1.default.createElement(Portal,{node:e.current&&e.current.getStage().container()},react_1.default.createElement("textarea",{ref:c,style:r,value:t.text,onChange:e=>{t.set({text:e.target.value})},onBlur:a}))}));function useHtmlSize(e,t){return react_1.default.useMemo((()=>(0,html2canvas_1.detectSize)(e)),[e,t.width])}exports.HTMLElement=(0,mobx_react_lite_1.observer)((({onClick:e,element:t,store:a})=>{const r=react_1.default.useRef(null),[n,o]=react_1.default.useState(!1),[l,i]=react_1.default.useState(!0),[d,s]=react_1.default.useState(!1),{onDragMove:c,onDragEnd:u}=(0,use_snap_1.useSnap)(r);(0,use_fadein_1.useFadeIn)(r);const f=`<div style="width: ${t.width||100}px; color: ${t.fill}; font-size: ${t.fontSize}px; font-family: '${t.fontFamily}';" contentEditable>${t.text}</div>`,{width:_,height:m}=useHtmlSize(f,t),[h,g]=react_1.default.useState();react_1.default.useEffect((()=>{n||async function(){i(!0);const e=await(0,html2canvas_1.htmlToCanvas)({html:f,width:t.width,height:m});g(e),i(!1)}()}),[f,n,m]);const p=n||l;return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(react_konva_1.Image,{ref:r,name:"element",image:h,x:t.x,y:t.y,rotation:t.rotation,width:t.width,height:h&&h.height/2,text:t.text,stroke:"black",strokeWidth:10,visible:!p,fillAfterStrokeEnabled:!0,fontSize:t.fontSize,fontFamily:t.fontFamily,fontStyle:t.fontStyle,textDecoration:t.textDecoration,align:t.align,draggable:!t.locked,opacity:d?0:t.opacity,shadowEnabled:t.shadowEnabled,shadowBlur:t.shadowBlur,onDragStart:()=>{a.selectedElements.find((e=>e===t))||a.selectElements([t.id])},onDragMove:c,onDragEnd:e=>{u(e),t.set({x:e.target.x(),y:e.target.y()})},id:t.id,onDblClick:()=>{t.locked||s(!0)},onDblTap:()=>{t.locked||s(!0)},onTransformStart:e=>{var t;const a=(null===(t=e.target.getStage())||void 0===t?void 0:t.findOne("Transformer")).getActiveAnchor();("middle-left"===a||"middle-right"===a)&&o(!0)},onTransform:e=>{var a;const r=(null===(a=e.target.getStage())||void 0===a?void 0:a.findOne("Transformer")).getActiveAnchor();if("middle-left"===r||"middle-right"===r){const a=e.target.scaleX(),r=Math.max(e.target.width()*a,t.fontSize);e.target.width(r),e.target.scaleX(1),t.set({width:r})}},onTransformEnd:e=>{o(!1);const a=e.target.scaleX();e.target.scaleX(1),e.target.scaleY(1),t.set({fontSize:t.fontSize*a,width:e.target.width()*a,x:e.target.x(),y:e.target.y(),rotation:e.target.rotation()})}}),p&&react_1.default.createElement(react_konva_1.Group,{x:t.x,y:t.y,rotation:t.rotation},react_1.default.createElement(react_konva_utils_1.Html,{divProps:{style:{pointerEvents:"none"}}},react_1.default.createElement("div",{dangerouslySetInnerHTML:{__html:f},contentEditable:!0,style:{pointerEvents:"none",display:"inline-block"}}))),d&&react_1.default.createElement(react_konva_1.Group,{x:t.x,y:t.y,rotation:t.rotation},react_1.default.createElement(react_konva_utils_1.Html,null,react_1.default.createElement("div",{dangerouslySetInnerHTML:{__html:f},contentEditable:!0,onBlur:e=>{console.log(e.target.childNodes[0].innerHTML),t.set({text:e.target.childNodes[0].innerHTML}),s(!1)}}))))}));
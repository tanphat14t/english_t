"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ElementsPanel=void 0;const react_1=__importDefault(require("react")),mobx_state_tree_1=require("mobx-state-tree"),core_1=require("@blueprintjs/core"),images_grid_1=require("./images-grid"),swr_1=__importDefault(require("swr")),image_1=require("../utils/image"),svg_1=require("../utils/svg"),l10n_1=require("../utils/l10n"),use_api_1=require("../utils/use-api"),api_1=require("../utils/api"),Iconscout=({query:e,store:t})=>{const{setQuery:a,loadMore:r,hasMore:i,data:s,isLoading:l}=(0,use_api_1.useInfiniteAPI)({defaultQuery:"",getAPI:({page:e,query:t})=>(0,api_1.iconscoutList)({page:e,query:t}),getSize:e=>e.response.items.last_page});return react_1.default.useEffect((()=>{a(e)}),[e]),react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement("p",{style:{textAlign:"center"}},"Icons by"," ",react_1.default.createElement("a",{href:"https://iconscout.com/",target:"_blank"},"iconscout")),react_1.default.createElement(images_grid_1.ImagesGrid,{shadowEnabled:!1,rowsNumber:3,images:null==s?void 0:s.map((e=>e.response.items.data)).flat(),getPreview:e=>e.urls.png_128,isLoading:l,loadMore:i&&r,onSelect:async(e,a,r)=>{if(r&&"image"===r.type){const{uuid:t}=e,a=await fetch((0,api_1.iconscoutDownload)(t)),{url:i}=await a.json();if(!i)return void alert("Image loading is failed. Please try again later.");const s=await(0,svg_1.urlToBase64)(i);return void r.set({clipSrc:s})}const{width:i,height:s}=await(0,image_1.getImageSize)(e.urls.png_128);t.history.transaction((async()=>{var r;const l=((null==a?void 0:a.x)||t.width/2)-i/2,o=((null==a?void 0:a.y)||t.height/2)-s/2,u=null===(r=t.activePage)||void 0===r?void 0:r.addElement({type:"svg",width:i,height:s,x:l,y:o}),{uuid:n}=e,c=await fetch((0,api_1.iconscoutDownload)(n)),{url:d}=await c.json();if(!d)return void alert("Image loading is failed. Please try again later.");const _=await(0,svg_1.urlToBase64)(d);(0,mobx_state_tree_1.isAlive)(u)&&await u.set({src:_})}))}}))},BasicShapes=({store:e})=>{const{data:t}=(0,swr_1.default)((0,api_1.polotnoShapesList)(),use_api_1.fetcher);return react_1.default.createElement(images_grid_1.ImagesGrid,{shadowEnabled:!1,rowsNumber:3,images:null==t?void 0:t.items,getPreview:e=>e.url,isLoading:!t,itemHeight:100,onSelect:async(t,a,r)=>{var i;const{width:s,height:l}=await(0,image_1.getImageSize)(t.url),o=await(0,svg_1.urlToBase64)(t.url);if(r&&"image"===r.type)return void r.set({clipSrc:o});const u=((null==a?void 0:a.x)||e.width/2)-s/2,n=((null==a?void 0:a.y)||e.height/2)-l/2;null===(i=e.activePage)||void 0===i||i.addElement({type:"svg",width:s,height:l,x:u,y:n,src:o,keepRatio:!1})}})},ElementsPanel=({store:e})=>{const t=react_1.default.useRef(),[a,r]=react_1.default.useState(""),[i,s]=react_1.default.useState(a);react_1.default.useEffect((()=>(t.current=setTimeout((()=>{s(a)}),500),()=>{clearTimeout(t.current)})),[a]);const l=!!a;return react_1.default.createElement("div",{style:{height:"100%",display:"flex",flexDirection:"column"}},react_1.default.createElement(core_1.InputGroup,{leftIcon:"search",placeholder:(0,l10n_1.t)("sidePanel.searchPlaceholder"),onChange:e=>{r(e.target.value)},style:{marginBottom:"20px"}}),l&&react_1.default.createElement(Iconscout,{query:i,store:e}),!l&&react_1.default.createElement(BasicShapes,{store:e}))};exports.ElementsPanel=ElementsPanel;